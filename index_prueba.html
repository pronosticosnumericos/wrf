<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WRF · Temperatura media (demo) · Leaflet + COG</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Raster libs -->
  <script src="https://unpkg.com/chroma-js@2.4.2/chroma.min.js"></script>
  <script src="https://unpkg.com/geotiff@2.1.3/dist-browser/geotiff.min.js"></script>
  <script src="https://unpkg.com/georaster@1.6.4/dist/georaster.bundle.min.js"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet@3.10.0/dist/georaster-layer-for-leaflet.min.js"></script>
  <script src="https://unpkg.com/geoblaze@1.3.3/dist/geoblaze.min.js"></script>
  <style>
    :root{ --bg:#ffffff; --muted:#6b7280; --shadow:0 6px 18px rgba(0,0,0,.15); --radius:14px; }
    html, body, #map { height: 100%; margin: 0; }
    body{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .panel { position:absolute; top:12px; left:12px; background:var(--bg); padding:12px 14px; border-radius:var(--radius); box-shadow:var(--shadow); }
    .legend { position:absolute; left:12px; bottom:12px; background:var(--bg); padding:12px 14px; border-radius:var(--radius); box-shadow:var(--shadow); font-size:12px; }
    .readout { position:absolute; right:12px; bottom:12px; background:var(--bg); padding:10px 12px; border-radius:var(--radius); box-shadow:var(--shadow); font-size:12px; }
    .title{ font-weight:700; font-size:14px; }
    .sub{ color:var(--muted); font-size:11px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; }
    .bar { height:10px; width:240px; border-radius:6px; }
    input, select, button{ font:12px/1 ui-sans-serif, system-ui; padding:6px 8px; border:1px solid #e5e7eb; border-radius:10px; }
    button{ cursor:pointer; }
    .spinner{ position:absolute; inset:auto 0 0 0; display:grid; place-items:center; padding-bottom:40vh; pointer-events:none; }
    .dot{ width:10px; height:10px; border-radius:50%; background:#111827; animation:b 1s infinite alternate; }
    @keyframes b{ to{ transform:scale(1.6); opacity:.2; } }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <div class="title">Temperatura media 2 m (24 h)</div>
    <div class="sub">Fuente: WRF · <span id="t-label">H+00–H+23</span></div>

    <div class="row">
      <label>Min (°C)
        <input id="min" type="number" step="0.5" value="10">
      </label>
      <label>Max (°C)
        <input id="max" type="number" step="0.5" value="35">
      </label>
    </div>

    <div class="row" style="grid-template-columns:1fr auto; align-items:end;">
      <label>Paleta
        <select id="palette">
          <option value="Turbo" selected>Turbo</option>
          <option value="Viridis">Viridis</option>
          <option value="Inferno">Inferno</option>
        </select>
      </label>
      <button id="auto" title="Calcular min/max desde datos">Auto</button>
    </div>

    <div class="sub" style="margin-top:6px">Ruta COG: <code id="cog-label">cog/tmean/tmean_20250919_00-24_4326_cog.tif</code></div>
  </div>

  <div class="legend">
    <div style="font-weight:700; margin-bottom:6px">Leyenda (°C)</div>
    <div class="bar" id="bar"></div>
    <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:11px">
      <span id="minlbl">10</span><span id="maxlbl">35</span>
    </div>
  </div>

  <div class="readout">
    <div style="font-weight:700;">Valor bajo cursor</div>
    <div id="val">—</div>
    <div class="sub" id="latlon"> </div>
  </div>

  <div class="spinner" id="spinner" aria-hidden="true"><div class="dot"></div></div>

  <script>
    // 1) CONFIGURA AQUÍ TU COG (ruta relativa en GitHub Pages)
    const COG_URL = '/home/sig07/website_nuevo/cog/tmean/tmean_20250919_00-24_4326_cog.tif';
    document.getElementById('cog-label').textContent = COG_URL;

    // 2) MAPA BASE + escala
    const map = L.map('map', { center: [22.5, -102.0], zoom: 5 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    L.control.scale({ metric:true, imperial:false }).addTo(map);

    // 3) UI y estado
    const minInput = document.getElementById('min');
    const maxInput = document.getElementById('max');
    const palInput = document.getElementById('palette');
    const autoBtn  = document.getElementById('auto');
    const spinner  = document.getElementById('spinner');

    let vmin = parseFloat(minInput.value);
    let vmax = parseFloat(maxInput.value);
    let paletteName = palInput.value;

    function getScale(){
      const name = paletteName;
      if(name==='Viridis') return chroma.scale('Viridis').domain([0,1]);
      if(name==='Inferno') return chroma.scale('Inferno').domain([0,1]);
      return chroma.scale('Turbo').domain([0,1]);
    }
    function drawRamp(){
      const el = document.getElementById('bar');
      const stops = Array.from({length: 16}, (_, i) => i / 15).map(s => getScale()(s).hex()).join(',');
      el.style.background = `linear-gradient(to right, ${stops})`;
      document.getElementById('minlbl').textContent = vmin;
      document.getElementById('maxlbl').textContent = vmax;
    }

    minInput.addEventListener('change', () => { vmin = parseFloat(minInput.value); drawRamp(); if(rasterLayer) rasterLayer.redraw(); });
    maxInput.addEventListener('change', () => { vmax = parseFloat(maxInput.value); drawRamp(); if(rasterLayer) rasterLayer.redraw(); });
    palInput.addEventListener('change', () => { paletteName = palInput.value; drawRamp(); if(rasterLayer) rasterLayer.redraw(); });

    drawRamp();

    // 4) Carga COG
    let rasterLayer = null; let georasterObj = null;

    (async () => {
      try {
        spinner.removeAttribute('aria-hidden');
        const ab = await (await fetch(COG_URL)).arrayBuffer();
        const georaster = await parseGeoraster(ab);
        georasterObj = georaster;

        rasterLayer = new GeoRasterLayer({
          georaster,
          resolution: 64,
          opacity: 0.9,
          pixelValuesToColorFn: (values) => {
            const v = values[0];
            if (v == null || Number.isNaN(v)) return 'rgba(0,0,0,0)';
            const t = (v - vmin) / (vmax - vmin);
            if (t <= 0) return getScale()(0).hex();
            if (t >= 1) return getScale()(1).hex();
            return getScale()(t).hex();
          }
        });
        rasterLayer.addTo(map);
        map.fitBounds(rasterLayer.getBounds());
      } catch (err) {
        console.error('Error cargando COG:', err);
        alert('No se pudo cargar el COG. Revisa la ruta en COG_URL.');
      } finally {
        spinner.setAttribute('aria-hidden','true');
      }
    })();

    // 5) Hover y click para leer valores
    map.on('mousemove', async (e) => {
      if (!georasterObj) return;
      try {
        const val = await geoblaze.identify(georasterObj, [e.latlng.lng, e.latlng.lat]);
        const num = Array.isArray(val) ? val[0] : val;
        document.getElementById('val').textContent = (num!=null && !Number.isNaN(num)) ? `${num.toFixed(2)} °C` : '—';
        document.getElementById('latlon').textContent = `${e.latlng.lat.toFixed(3)}, ${e.latlng.lng.toFixed(3)}`;
      } catch(_){}
    });

    map.on('click', async (e) => {
      if (!georasterObj) return;
      try {
        const val = await geoblaze.identify(georasterObj, [e.latlng.lng, e.latlng.lat]);
        const num = Array.isArray(val) ? val[0] : val;
        L.popup()
          .setLatLng(e.latlng)
          .setContent(`<div style="font:12px ui-sans-serif"><b>Tmedia 2 m (°C)</b><br>${(num!=null?num.toFixed(2):'—')} °C<br><span style="color:#6b7280">${e.latlng.lat.toFixed(3)}, ${e.latlng.lng.toFixed(3)}</span></div>`)
          .openOn(map);
      } catch(_){}
    });

    // 6) Auto rango desde estadísticas
    autoBtn.addEventListener('click', async () => {
      if(!georasterObj) return;
      try {
        spinner.removeAttribute('aria-hidden');
        const stats = await geoblaze.stats(georasterObj);
        if(stats && stats[0]){
          const s = stats[0];
          vmin = typeof s.min === 'number' ? +s.min.toFixed(1) : vmin;
          vmax = typeof s.max === 'number' ? +s.max.toFixed(1) : vmax;
          minInput.value = vmin; maxInput.value = vmax;
          drawRamp(); if(rasterLayer) rasterLayer.redraw();
        }
      } catch(err){ console.warn('No se pudieron calcular stats', err); }
      finally{ spinner.setAttribute('aria-hidden','true'); }
    });
  </script>
</body>
</html>

